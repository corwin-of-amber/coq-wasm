(executable
 (name icoq)
 (modes byte)
 (modules icoq icoq_init wacoq_proto)
 (preprocess (staged_pps ppx_import ppx_deriving_yojson))
 (libraries coq.stm coq.toplevel yojson coq-serapi.serlib coq-serapi.serapi_v8_11)
 (link_flags -linkall -no-check-prims))

(rule
 (targets dllbyterun_stubs.wasm)
 (deps byterun_stubs.c (env_var EMSDK))
 (action
  (bash "source $EMSDK/emsdk_env.sh && \
	emcc -Os -s SIDE_MODULE=1 byterun_stubs.c -o %{targets} \
         -I%{ocaml-config:standard_library}")))